<div class="tasks-container">

  <div *ngIf="!showCreateTaskForm && !editingTask">

    <div class="header">
      <h2>All Tasks</h2>

      <div class="header-actions">
        <button class="filter-btn" (click)="showFilters = true">
          Filters
        </button>

        <button class="create-btn" (click)="toggleCreateTaskForm()">
          Create New Task
        </button>
      </div>
    </div>

    <div *ngIf="showFilters" class="filter-overlay" (click)="showFilters = false">
      <div class="filter-panel" (click)="$event.stopPropagation()">

        <div class="filter-card">
          <div class="card-header">
            <span>Status</span>
          </div>

          <label><input type="checkbox" value="To Do" (change)="onStatusChange($event)"> To Do</label>
          <label><input type="checkbox" value="In Progress" (change)="onStatusChange($event)"> In Progress</label>
          <label><input type="checkbox" value="Done" (change)="onStatusChange($event)"> Done</label>
          <label><input type="checkbox" value="On Hold" (change)="onStatusChange($event)"> On Hold</label>
        </div>

        <div class="filter-card">
          <div class="card-header">
            <span>Priority</span>
          </div>

          <label><input type="checkbox" value="low" (change)="onPriorityChange($event)"> Low</label>
          <label><input type="checkbox" value="medium" (change)="onPriorityChange($event)"> Medium</label>
          <label><input type="checkbox" value="high" (change)="onPriorityChange($event)"> High</label>
          <label><input type="checkbox" value="urgent" (change)="onPriorityChange($event)"> Urgent</label>
        </div>

        <div class="filter-card">
          <div class="card-header">
            <span>Assignee</span>
          </div>

          <label><input type="checkbox" value="Hemanth" (change)="onAssignedChange($event)"> Hemanth</label>
          <label><input type="checkbox" value="Vinoth" (change)="onAssignedChange($event)"> Vinoth</label>
          <label><input type="checkbox" value="Dinesh" (change)="onAssignedChange($event)"> Dinesh</label>
          <label><input type="checkbox" value="Shivam" (change)="onAssignedChange($event)"> Shivam</label>
        </div>

        <div class="clear-all">
          <button (click)="clearAllFilters()">Clear All Filters</button>
        </div>

      </div>
    </div>

    <table *ngIf="filteredTasks.length">
      <thead>
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Priority</th>
          <th>Assignee</th>
          <th>Due Date</th>
          <th>Project</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let t of filteredTasks"
            (click)="viewTask(t)"
            class="task-row">

          <td>{{ t.title }}</td>

          <td>
            <span class="badge"
              [ngClass]="{
                'status-done': t.status === 'Done',
                'status-progress': t.status === 'In Progress',
                'status-todo': t.status === 'To Do',
                'status-hold': t.status === 'On Hold'
              }">
              {{ t.status }}
            </span>
          </td>

          <td>
            <span class="badge"
              [ngClass]="{
                'priority-low': t.priority === 'low',
                'priority-medium': t.priority === 'medium',
                'priority-high': t.priority === 'high',
                'priority-urgent': t.priority === 'urgent'
              }">
              {{ t.priority | titlecase }}
            </span>
          </td>

          <td class="assignee">
            <div class="avatar">
              {{ t.assigned ? (t.assigned[0] | uppercase) : '' }}
            </div>
            {{ t.assigned }}
          </td>

          <td>{{ t.dueDate }}</td>
          <td>{{ t.projectTitle }}</td>

          <td class="actions">
            <span (click)="updateTask(t); $event.stopPropagation()">✏️</span>
            <img src="/icons/delete.png"
                 (click)="deleteTask(t); $event.stopPropagation()">
          </td>

        </tr>
      </tbody>
    </table>

    <p *ngIf="!filteredTasks.length" class="no-tasks">
      No tasks found
    </p>

  </div>

  <!-- ================= CREATE PAGE ================= -->
  <div *ngIf="showCreateTaskForm && !editingTask" class="create-page">

    <div class="create-header">
      <h1>Create Task</h1>
      <p>Create your task</p>
    </div>

    <div class="create-card">

      <form (ngSubmit)="createTask()">

        <div class="row">
          <div class="field">
            <label>Project *</label>
            <select [(ngModel)]="newTask.projectId" name="projectId" required>
              <option [ngValue]="null">Select project</option>
              <option *ngFor="let p of projects" [ngValue]="p.id">
                {{ p.title }}
              </option>
            </select>
          </div>

          <div class="field">
            <label>Title *</label>
            <input type="text"
                   [(ngModel)]="newTask.title"
                   name="title"
                   placeholder="Enter task title"
                   required>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Status *</label>
            <select [(ngModel)]="newTask.status" name="status">
              <option>To Do</option>
              <option>In Progress</option>
              <option>Done</option>
              <option>On Hold</option>
            </select>
          </div>

          <div class="field">
            <label>Priority *</label>
            <select [(ngModel)]="newTask.priority" name="priority">
              <option>low</option>
              <option>medium</option>
              <option>high</option>
              <option>urgent</option>
            </select>
          </div>
        </div>

        <div class="field full">
          <label>Description</label>
          <textarea [(ngModel)]="newTask.description"
                    name="description"
                    placeholder="Enter description (optional)">
          </textarea>
        </div>

        <div class="row">
          <div class="field">
            <label>Assignee *</label>
            <input type="text"
                   [(ngModel)]="newTask.assigned"
                   name="assigned"
                   required>
          </div>

          <div class="field">
            <label>Due Date *</label>
            <input type="date"
                   [(ngModel)]="newTask.dueDate"
                   name="dueDate"
                   required>
          </div>
        </div>

        <div class="buttons">
          <button type="submit" class="main-btn">
            Create Task
          </button>

          <button type="button"
                  class="secondary-btn"
                  (click)="toggleCreateTaskForm()">
            Cancel
          </button>
        </div>

      </form>

    </div>
  </div>

  <!-- ================= UPDATE TASK PAGE ================= -->
  <div *ngIf="editingTask" class="update-page">

    <div class="update-header">
      <h1>Edit Task</h1>
      <p>Update your task</p>
    </div>

    <div class="update-card">

      <form (ngSubmit)="saveEditedTask()">

        <div class="row">
          <div class="field">
            <label>Project</label>
            <select [(ngModel)]="editTaskForm.projectId" name="projectId">
              <option [ngValue]="null">Select project</option>
              <option *ngFor="let p of projects" [ngValue]="p.id">
                {{ p.title }}
              </option>
            </select>
          </div>

          <div class="field">
            <label>Title *</label>
            <input type="text"
                   [(ngModel)]="editTaskForm.title"
                   name="title"
                   placeholder="Enter task title"
                   required>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Status</label>
            <select [(ngModel)]="editTaskForm.status" name="status">
              <option>To Do</option>
              <option>In Progress</option>
              <option>Done</option>
              <option>On Hold</option>
            </select>
          </div>

          <div class="field">
            <label>Priority</label>
            <select [(ngModel)]="editTaskForm.priority" name="priority">
              <option>low</option>
              <option>medium</option>
              <option>high</option>
              <option>urgent</option>
            </select>
          </div>
        </div>

        <div class="field full">
          <label>Description</label>
          <textarea [(ngModel)]="editTaskForm.description"
                    name="description"
                    placeholder="Enter description (optional)">
          </textarea>
        </div>

        <div class="row">
          <div class="field">
            <label>Assignee</label>
            <input type="text"
                   [(ngModel)]="editTaskForm.assigned"
                   name="assigned">
          </div>

          <div class="field">
            <label>Due Date</label>
            <input type="date"
                   [(ngModel)]="editTaskForm.dueDate"
                   name="dueDate">
          </div>
        </div>

        <div class="buttons">
          <button type="submit" class="main-btn">
            Update Task
          </button>

          <button type="button"
                  class="secondary-btn"
                  (click)="cancelEdit()">
            Cancel
          </button>
        </div>

      </form>

    </div>
  </div>

  <!-- ================= TASK DETAILS MODAL ================= -->
  <div *ngIf="selectedTask" class="modal-overlay" (click)="closeTaskDetails()">

    <div class="modal-content" (click)="$event.stopPropagation()">

      <div class="modal-header">
        <h3>{{ selectedTask.title }}</h3>
        <button class="close-btn" (click)="closeTaskDetails()">✕</button>
      </div>

      <div class="modal-body">

        <div class="badge-row">
          <span class="badge"
                [ngClass]="{
                  'status-done': selectedTask.status === 'Done',
                  'status-progress': selectedTask.status === 'In Progress',
                  'status-todo': selectedTask.status === 'To Do',
                  'status-hold': selectedTask.status === 'On Hold'
                }">
            {{ selectedTask.status }}
          </span>

          <span class="badge"
                [ngClass]="{
                  'priority-low': selectedTask.priority === 'low',
                  'priority-medium': selectedTask.priority === 'medium',
                  'priority-high': selectedTask.priority === 'high',
                  'priority-urgent': selectedTask.priority === 'urgent'
                }">
            {{ selectedTask.priority | titlecase }}
          </span>
        </div>

        <p><strong>Assigned:</strong> {{ selectedTask.assigned }}</p>
        <p><strong>Due Date:</strong> {{ selectedTask.dueDate }}</p>
        <p><strong>Project:</strong> {{ selectedTask.projectTitle }}</p>
        <p><strong>Description:</strong> {{ selectedTask.description }}</p>

      </div>

    </div>
  </div>

</div>
